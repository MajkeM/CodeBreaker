<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Server Data Stream</title>
  <style>
    body {
      margin: 0;
      font-family: "Fira Code", "Courier New", monospace;
      background: #020a12;
      color: #00f3ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      user-select: none;
      overflow: hidden;
    }

    .panel {
      background: rgba(10, 20, 40, 0.9);
      border: 2px solid #00f3ff;
      border-radius: 12px;
      padding: 20px;
      width: min(400px, 90vw);
      box-shadow: 0 0 25px rgba(0, 243, 255, 0.2);
      text-align: center;
      position: relative;
    }

    h1 {
      margin: 0 0 15px;
      font-size: 1.2rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      border-bottom: 1px solid #004e52;
      padding-bottom: 10px;
    }

    .target-display {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 20px;
      color: #fff;
      text-shadow: 0 0 10px #00f3ff;
      background: #002a2e;
      padding: 10px;
      border-radius: 6px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .cell {
      background: #051624;
      border: 1px solid #005f63;
      color: #008c94;
      padding: 15px 0;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.1s;
      border-radius: 4px;
    }

    .cell:hover {
      background: #00f3ff;
      color: #000;
      box-shadow: 0 0 15px #00f3ff;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: #051624;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 10px;
    }

    .progress-fill {
      height: 100%;
      background: #00f3ff;
      width: 0%;
      transition: width 0.3s ease;
    }

    .timer-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 4px;
      background: #ff0055;
      width: 100%;
      transition: width 1s linear;
    }

    #status {
      margin-top: 10px;
      font-size: 0.9rem;
      min-height: 1.2em;
    }

    @keyframes shake {
      0% { transform: translate(1px, 1px) rotate(0deg); }
      10% { transform: translate(-1px, -2px) rotate(-1deg); }
      20% { transform: translate(-3px, 0px) rotate(1deg); }
      30% { transform: translate(3px, 2px) rotate(0deg); }
      40% { transform: translate(1px, -1px) rotate(1deg); }
      50% { transform: translate(-1px, 2px) rotate(-1deg); }
      60% { transform: translate(-3px, 1px) rotate(0deg); }
      70% { transform: translate(3px, 1px) rotate(-1deg); }
      80% { transform: translate(-1px, -1px) rotate(1deg); }
      90% { transform: translate(1px, 2px) rotate(0deg); }
      100% { transform: translate(1px, -2px) rotate(-1deg); }
    }

    .shake {
      animation: shake 0.5s;
      border-color: #ff0055;
    }
  </style>
</head>
<body>

  <div class="panel" id="game-panel">
    <h1>Synchronizace Dat</h1>
    <div id="status">Najdi kód v mřížce...</div>
    
    <div class="target-display" id="target-code">--</div>
    
    <div class="grid" id="grid">
      <!-- Cells generated by JS -->
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progress"></div>
    </div>
    
    <div class="timer-bar" id="timer"></div>
  </div>

  <script>
    const hexChars = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F'];
    const gridSize = 16; // 4x4
    const gridEl = document.getElementById('grid');
    const targetEl = document.getElementById('target-code');
    const progressEl = document.getElementById('progress');
    const timerEl = document.getElementById('timer');
    const statusEl = document.getElementById('status');
    const panelEl = document.getElementById('game-panel');

    let score = 0;
    const targetScore = 3;
    let timeLeft = 15; // sekund na celou hru
    let currentTarget = '';
    let gameInterval;
    let shuffleInterval;
    let isRunning = true;

    function randomHex() {
      return hexChars[Math.floor(Math.random() * hexChars.length)] + 
             hexChars[Math.floor(Math.random() * hexChars.length)];
    }

    function generateGrid() {
      gridEl.innerHTML = '';
      let cells = [];
      
      for (let i = 0; i < gridSize; i++) {
        cells.push(randomHex());
      }

      // Ujistíme se, že cíl je v mřížce
      const targetIndex = Math.floor(Math.random() * gridSize);
      cells[targetIndex] = currentTarget;

      cells.forEach(code => {
        const div = document.createElement('div');
        div.className = 'cell';
        div.textContent = code;
        div.onmousedown = () => handleClick(code, div);
        gridEl.appendChild(div);
      });
    }

    function setNextRound() {
      if (score >= targetScore) {
        endGame(true);
        return;
      }
      currentTarget = randomHex();
      targetEl.textContent = currentTarget;
      generateGrid();
    }

    function handleClick(code, element) {
      if (!isRunning) return;

      if (code === currentTarget) {
        score++;
        progressEl.style.width = (score / targetScore * 100) + '%';
        statusEl.textContent = "DATA PŘIJATA...";
        statusEl.style.color = "#00f3ff";
        setNextRound();
      } else {
        timeLeft -= 3;
        statusEl.textContent = "CHYBA PARITY! (-3s)";
        statusEl.style.color = "#ff0055";
        panelEl.classList.add('shake');
        setTimeout(() => panelEl.classList.remove('shake'), 500);
        generateGrid();
      }
    }

    function updateTimer() {
      timeLeft -= 0.1;
      const percentage = (timeLeft / 15) * 100;
      timerEl.style.width = percentage + '%';

      if (timeLeft <= 5) {
        timerEl.style.backgroundColor = "#ff0000";
      }

      if (timeLeft <= 0) {
        endGame(false);
      }
    }

    function endGame(win) {
      isRunning = false;
      clearInterval(gameInterval);
      clearInterval(shuffleInterval);
      
      if (win) {
        statusEl.textContent = "PŘÍSTUP POVOLEN";
        targetEl.textContent = "OK";
        targetEl.style.color = "#00ff00";
        setTimeout(() => {
            window.parent?.postMessage('minigame_win', '*');
        }, 1000);
      } else {
        statusEl.textContent = "SPOJENÍ ZTRACENO";
        targetEl.textContent = "ERR";
        targetEl.style.color = "#ff0000";
        setTimeout(() => {
            window.parent?.postMessage('minigame_fail', '*');
        }, 1000);
      }
    }

    // Start hry
    setNextRound();
    
    // Hlavní časovač
    gameInterval = setInterval(updateTimer, 100);

    // Automatické míchání mřížky každé 2.5s
    shuffleInterval = setInterval(generateGrid, 2500);
  </script>
</body>
</html>